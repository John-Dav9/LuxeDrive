<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Luxe Drive" %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="manifest" href="<%= pwa_manifest_path %>">
    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">
   <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="d-flex flex-column" style="min-height: 100vh;">

  <div class="navbar navbar-expand-sm navbar-light navbar-lewagon">
    <div class="container-fluid">


            <%= link_to root_path, class: "navbar-brand", style:"display: contents" do %>
              <%= image_tag "logo.png" %>
            <% end %>



              

      <% if user_signed_in? %>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto">
            <!-- Menu sp√©cifique selon le r√¥le -->
            <% if current_user.super_admin? %>
              <li class="nav-item">
                <%= link_to "üîß Super Admin", super_admin_root_path, class: "nav-link fw-bold text-danger" %>
              </li>
            <% end %>
            
            <li class="nav-item">
              <%= link_to "Accueil", root_path, class: "nav-link" %>
            </li>

            <% if current_user.visitor? %>
              <li class="nav-item">
                <% if current_user.owner_request.present? %>
                  <%= link_to "Mon dossier prestataire", owner_request_path, class: "nav-link" %>
                <% else %>
                  <%= link_to "Devenir prestataire", new_owner_request_path, class: "nav-link" %>
                <% end %>
              </li>
            <% end %>
            
            <% if current_user.admin? %>
              <li class="nav-item">
                <%= link_to "üìã Mes Voitures", owner_cars_path, class: "nav-link" %>
              </li>
              <li class="nav-item">
                <%= link_to "üìä Tableau de bord", owner_root_path, class: "nav-link" %>
              </li>
              <li class="nav-item">
                <%= link_to "üìä Mes R√©servations", owner_bookings_path, class: "nav-link" %>
              </li>
            <% end %>

            <li class="nav-item dropdown">
              <% if current_user.super_admin? %>
                <%= image_tag "T02NE0241-U07Q4PW5W2K-b9cf4c0c8442-512.jpg", class: "avatar dropdown-toggle", id: "navbarDropdown", data: { bs_toggle: "dropdown" }, 'aria-haspopup': true, 'aria-expanded': false, alt: "Super admin" %>
              <% else %>
                <% initials = "#{current_user.first_name&.first}#{current_user.last_name&.first}".upcase %>
                <span class="avatar avatar-initials dropdown-toggle" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><%= initials %></span>
              <% end %>
              <div class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <div class="dropdown-header">
                  <strong><%= current_user.full_name %></strong><br>
                  <small class="text-muted"><%= current_user.email %></small>
                </div>
                <div class="dropdown-divider"></div>

                <% if current_user.super_admin? %>
                  <%= link_to "üîß Panneau Super Admin", super_admin_root_path, class: "dropdown-item" %>
                  <div class="dropdown-divider"></div>
                <% end %>

                <%= link_to "üîî Notifications", notifications_path, class: "dropdown-item" %>
                <%= link_to "üìÖ Mes r√©servations", dashboard_path, class: "dropdown-item" %>
                <div class="dropdown-divider"></div>
                <%= link_to "D√©connexion", destroy_user_session_path, class: "dropdown-item", data: {turbo_method: :delete} %>
              </div>
            </li>
            <li class="nav-item ms-2">
              <%= link_to notifications_path, class: "nav-link notif-bell", id: "notifBell" do %>
                <i class="fas fa-bell"></i>
                <span class="notif-badge d-none" id="notifBadge">0</span>
              <% end %>
            </li>
          </ul>
        </div>
      <% else %>
        <div class="ms-auto d-flex align-items-center gap-2">
          <%= link_to "Se connecter", new_user_session_path, class: "btn btn-outline-primary btn-sm" %>
          <%= link_to "Inscription", new_user_registration_path, class: "btn btn-primary btn-sm text-white" %>
        </div>
      <% end %>
    </div>
  </div>

  <main>
    <%= yield %>
  </main>

  <div id="notifToast" class="toast align-items-center text-bg-dark border-0 position-fixed bottom-0 end-0 m-4 d-none" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="notifToastBody"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="document.getElementById('notifToast').classList.add('d-none')"></button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const badge = document.getElementById('notifBadge');
      const toast = document.getElementById('notifToast');
      const toastBody = document.getElementById('notifToastBody');

      if (!badge) return;

      async function fetchNotifications() {
        const res = await fetch("<%= notifications_path(format: :json) %>");
        if (!res.ok) return;
        const data = await res.json();
        const count = data.unread_count || 0;
        badge.textContent = count;
        badge.classList.toggle('d-none', count === 0);

        if (data.latest && data.latest.id) {
          const lastId = toast.dataset.lastId;
          if (String(lastId) !== String(data.latest.id)) {
            toastBody.textContent = data.latest.title + " ‚Äî " + (data.latest.body || "");
            toast.classList.remove('d-none');
            toast.dataset.lastId = data.latest.id;
          }
        }
      }

      fetchNotifications();
      setInterval(fetchNotifications, 30000);
    });
  </script>

  <footer class="footer">
    <div class="footer-wrapper">
      <div class="footer-grid">
        <!-- Column 1: About -->
        <div class="footer-col">
          <h3>LuxeDrive</h3>
          <ul>
            <li><%= link_to "Accueil", root_path %></li>
            <li><%= link_to "Parcourir", cars_path %></li>
            <li><%= link_to "√Ä propos", about_path %></li>
            <li><a href="mailto:contact@luxedrive.com">Contact</a></li>
          </ul>
        </div>

        <!-- Column 2: For Renters -->
        <div class="footer-col">
          <h3>Pour vous</h3>
          <ul>
            <li><%= link_to "Trouver une voiture", cars_path %></li>
            <li><%= link_to "Mes r√©servations", dashboard_path, class: (user_signed_in? ? "" : "disabled") %></li>
            <li><a href="mailto:support@luxedrive.com">Support client</a></li>
            <li><%= link_to "FAQ", faq_path %></li>
          </ul>
        </div>

        <!-- Column 3: For Owners -->
        <div class="footer-col">
          <h3>Propri√©taires</h3>
          <ul>
            <li><%= link_to "Publier voiture", new_car_path, class: (user_signed_in? && current_user.admin? ? "" : "disabled") %></li>
            <li><%= link_to "R√©servations", owner_bookings_path, class: (user_signed_in? && current_user.admin? ? "" : "disabled") %></li>
            <li><%= link_to "Tarifs", pricing_path %></li>
            <li><%= link_to "Guide propri√©taire", owner_guide_path %></li>
          </ul>
        </div>

        <!-- Column 4: Legal & Social -->
        <div class="footer-col">
          <h3>L√©gal</h3>
          <ul>
            <li><%= link_to "Conditions", legal_path %></li>
            <li><%= link_to "Confidentialit√©", privacy_path %></li>
            <li><%= link_to "Cookies", cookies_path %></li>
            <li><%= link_to "Mentions l√©gales", mentions_legales_path %></li>
          </ul>
          
          <h3 style="margin-top: 2rem;">Suivez-nous</h3>
          <div class="footer-socials">
            <a href="https://instagram.com" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="https://facebook.com" target="_blank" title="Facebook"><i class="fab fa-facebook"></i></a>
            <a href="https://twitter.com" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>
            <a href="https://linkedin.com" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a>
          </div>
        </div>
      </div>

      <!-- Footer Bottom -->
      <div class="footer-bottom">
        <p>&copy; <%= Date.today.year %> LuxeDrive. Tous droits r√©serv√©s.</p>
      </div>
    </div>
  </footer>
